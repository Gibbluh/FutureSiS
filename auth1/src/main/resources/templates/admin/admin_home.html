<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Admin Dashboard</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --danger-color: #f44336;
            --danger-hover: #d32f2f;
            --border-color: #ddd;
            --success-bg: #dff0d8;
            --success-text: #3c763d;
            --error-bg: #f2dede;
            --error-text: #a94442;
        }
        
        /* Add hidden column class */
        .hidden-column {
            display: none;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select, textarea {
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--primary-hover);
        }
        
        .logout-btn {
            background-color: var(--danger-color);
        }
        
        .logout-btn:hover {
            background-color: var(--danger-hover);
        }
        
        .message {
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .success {
            background-color: var(--success-bg);
            color: var(--success-text);
            border-left: 4px solid var(--success-text);
        }
        
        .error {
            background-color: var(--error-bg);
            color: var(--error-text);
            border-left: 4px solid var(--error-text);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .edit-btn {
            background-color: #2196F3;
        }
        
        .edit-btn:hover {
            background-color: #0b7dda;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 0;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .section {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        /* Modern Tab Design */
        .tabs-container {
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            border: none;
            padding-bottom: 0;
        }

        .tab {
            font-size: 24px;
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            color: #333;
            position: relative;
            transition: color 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            color: #007bff;
        }

        .tab.active {
            color: #007bff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #007bff;
            border-radius: 3px;
        }

        /* Form Tabs */
        .form-tabs-content > .tab-content {
            display: none;
        }

        .form-tabs-content > .tab-content.active {
            display: block;
        }

        /* Record Tabs */
        .records-section .tab-contents > .tab-content {
            display: none;
        }

        .records-section .tab-contents > .tab-content.active {
            display: block;
        }

        .tab-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        /* Card Design for Content */
        .content-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Add some spacing between sections */
        .records-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        /* Update the multiselect dropdown styles */
        .multiselect-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 10px;
        }

        .multiselect-dropdown-list {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
            padding: 0;
        }

        .multiselect-dropdown-list.show {
            display: block;
        }

        .multiselect-dropdown-toggle {
            width: 100%;
            padding: 10px 12px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            color: #333;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .multiselect-dropdown-toggle:hover {
            border-color: #aaa;
        }

        .multiselect-dropdown-toggle:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .multiselect-dropdown-toggle.show:after {
            transform: rotate(180deg);
        }

        .multiselect-dropdown-toggle:after {
            content: 'â–¼';
            margin-left: 8px;
            font-size: 12px;
            transition: transform 0.2s;
            color: #666;
        }

        .multiselect-dropdown-option {
            padding: 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .multiselect-dropdown-option:last-child {
            border-bottom: none;
        }

        .multiselect-dropdown-option:hover {
            background-color: #f8f9fa;
        }

        .multiselect-dropdown-option label {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 0;
            cursor: pointer;
            width: 100%;
            font-weight: normal;
            transition: background-color 0.2s;
        }

        .multiselect-dropdown-option label:hover {
            background-color: #f8f9fa;
        }

        .multiselect-dropdown-option input[type="checkbox"] {
            margin: 0;
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .multiselect-dropdown-option input[type="checkbox"]:checked + span {
            color: #4CAF50;
            font-weight: 500;
        }

        .multiselect-dropdown-option span {
            font-size: 14px;
            color: #333;
            transition: color 0.2s;
        }

        .multiselect-dropdown-toggle.placeholder {
            color: #666;
            font-weight: normal;
        }

        .multiselect-dropdown-toggle.has-selections {
            color: #333;
            font-weight: 500;
        }

        /* Custom scrollbar for the dropdown */
        .multiselect-dropdown-list::-webkit-scrollbar {
            width: 8px;
        }

        .multiselect-dropdown-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .multiselect-dropdown-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .multiselect-dropdown-list::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* Subject assignments styling */
        .program-subjects-wrapper {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .program-subjects-section {
            margin: 0;
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 20px;
        }

        .program-subjects-section:last-child {
            border-bottom: none;
        }

        .program-subjects-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .subject-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .subject-item:hover {
            background-color: #fff;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .subject-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            cursor: pointer;
            width: 100%;
            font-weight: normal;
        }

        .subject-item input[type="checkbox"] {
            margin: 0;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .subject-item input[type="checkbox"]:checked + span {
            font-weight: 500;
            color: #007bff;
        }

        .subject-item span {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            color: #495057;
            transition: color 0.2s;
        }

        /* Empty state styling */
        .no-subjects-message {
            padding: 30px;
            text-align: center;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 20px 0;
        }

        /* Loading state styling */
        .loading-subjects {
            padding: 30px;
            text-align: center;
            color: #007bff;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 20px 0;
        }

        .loading-subjects:after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            text-align: right;
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #333;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
            transition: background-color 0.2s;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Update tab content styles */
        .form-tabs-content .tab-contents > .tab-content {
            display: none;
        }

        .form-tabs-content .tab-contents > .tab-content.active {
            display: block;
        }

        .records-section .tab-contents > .tab-content {
            display: none;
        }

        .records-section .tab-contents > .tab-content.active {
            display: block;
        }

        .tab-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        .multiselect-dropdown-list.show {
            display: block;
        }

        .multiselect-dropdown-toggle.show:after {
            transform: rotate(180deg);
        }

        /* Add styles for semester tabs */
        .semester-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .semester-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 2px solid #007bff;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .semester-content {
            padding: 20px;
            background: white;
        }

        .semester-section {
            margin-bottom: 30px;
        }

        .semester-section:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Admin Dashboard</h2>
            <p>Welcome, <span th:text="${username}"></span>!</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <!-- <a th:href="@{/approvals/pending}" class="btn" style="text-decoration: none; color: white; background-color: #2196F3; padding: 10px 20px; border-radius: 4px; display: inline-block;">
                    Pending Approvals
                </a> -->
                <form th:action="@{/admin/logout}" method="post" style="margin: 0;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="logout-btn">Logout</button>
                </form>
            </div>
        </div>

        <!-- Add Forms Section -->
        <div class="form-tabs-content">
        <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'add-student')">Add Student</button>
                <button class="tab" onclick="switchTab(event, 'add-faculty')">Add Faculty</button>
        </div>

            <div class="tab-contents">
        <!-- Add Student Form -->
        <div id="add-student" class="tab-content active">
            <div class="content-card">
                <h2>Add New Student</h2>
                <form th:action="@{/admin/students/add}" method="post" id="studentForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name:</label>
                            <input type="text" id="firstName" name="firstName" required 
                                   pattern="[A-Za-z ]+" title="Only letters and spaces allowed">
                        </div>
                        
                        <div class="form-group">
                            <label for="lastName">Last Name:</label>
                            <input type="text" id="lastName" name="lastName" required
                                   pattern="[A-Za-z ]+" title="Only letters and spaces allowed">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required
                                   pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" 
                                   title="Enter a valid email address">
                        </div>
                        
                        <div class="form-group">
                            <label for="birthDate">Birth Date:</label>
                            <input type="date" id="birthDate" name="birthDate" required
                                   th:max="${T(java.time.LocalDate).now().minusYears(10).toString()}"
                                   th:min="${T(java.time.LocalDate).now().minusYears(100).toString()}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" id="password" name="password" required
                                   placeholder="Suggestion: Use at least 6 characters with letters and numbers"
                                   style="color: #666;">
                            <small style="color: #666; font-style: italic;">Tip: Strong passwords help protect your account</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number:</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" 
                                   pattern="[0-9\-\+\(\) ]+" title="Enter a valid phone number">
                        </div>
                        
                        <div class="form-group">
                            <label for="address">Address:</label>
                            <textarea id="address" name="address" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="programId">Program:</label>
                            <select id="programId" name="programId" required>
                                <option value="">-- Select Program --</option>
                                <option th:each="program : ${programs}" th:value="${program.id}" th:text="${program.name}"></option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="enrollmentYear">Year Level:</label>
                            <select id="enrollmentYear" name="enrollmentYear" required>
                                <option value="">-- Select Year Level --</option>
                                <option value="1">1st Year - Freshmen</option>
                                <option value="2">2nd Year - Sophomore</option>
                                <option value="3">3rd Year - Junior</option>
                                <option value="4">4th Year - Senior</option>
                            </select>
                        </div>
                    </div>
                    <!-- Enrollment date is handled automatically by the system -->
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="submit">Add Student</button>
                        <a href="/admin/programs" class="btn" style="text-decoration: none; color: white; background-color: #4CAF50; padding: 10px 20px; border-radius: 4px; display: inline-block;">Manage Programs</a>
                    </div>
                    
                    <div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
                    <div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>
                </form>
            </div>
        </div>

        <!-- Add Faculty Form -->
        <div id="add-faculty" class="tab-content">
            <div class="content-card">
                <h2>Add New Faculty</h2>
                <form th:action="@{/admin/faculty/add}" method="post" id="facultyForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="facultyId">Faculty ID:</label>
                            <input type="text" id="facultyId" name="facultyId" required
                                   onblur="checkFacultyIdUnique(this.value)">
                            <span id="facultyIdError" class="error-message" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required
                                   pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                                   title="Enter a valid email address">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name:</label>
                            <input type="text" id="firstName" name="firstName" required 
                                   pattern="[A-Za-z ]+" title="Only letters and spaces allowed">
                        </div>
                        
                        <div class="form-group">
                            <label for="lastName">Last Name:</label>
                            <input type="text" id="lastName" name="lastName" required
                                   pattern="[A-Za-z ]+" title="Only letters and spaces allowed">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" id="password" name="password" required
                                   placeholder="Suggestion: Use at least 6 characters with letters and numbers"
                                   style="color: #666;">
                            <small style="color: #666; font-style: italic;">Tip: Strong passwords help protect your account</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="programIds">Departments:</label>
                            <div class="multiselect-dropdown">
                                <button type="button" class="multiselect-dropdown-toggle">
                                            <span>Select Departments</span>
                                </button>
                                <div class="multiselect-dropdown-list">
                                    <div th:each="program : ${programs}" class="multiselect-dropdown-option">
                                        <label>
                                            <input type="checkbox" 
                                                   name="programIds"
                                                   th:value="${program.id}">
                                            <span th:text="${program.name}"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <small style="color: #666; font-style: italic;">Select one or more departments</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="phoneNumber">Phone Number (Optional):</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber"
                                   pattern="[0-9\-\+\(\) ]+" title="Enter a valid phone number">
                        </div>
                        
                        <div class="form-group">
                            <label for="position">Position:</label>
                            <input type="text" id="position" name="position" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="address">Address (Optional):</label>
                            <input type="text" id="address" name="address">
                        </div>
                    </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="facultyYearLevel">Year Level:</label>
                                    <select id="facultyYearLevel" name="yearLevel" required>
                                        <option value="">-- Select Year Level --</option>
                                        <option value="1">1st Year - Freshmen</option>
                                        <option value="2">2nd Year - Sophomore</option>
                                        <option value="3">3rd Year - Junior</option>
                                        <option value="4">4th Year - Senior</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="facultySemester">Semester:</label>
                                    <select id="facultySemester" name="semester" required>
                                        <option value="">-- Select Semester --</option>
                                        <option value="1">1st Semester</option>
                                        <option value="2">2nd Semester</option>
                                    </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="subjectAssignments">Subject Assignments:</label>
                            <div id="subjectAssignments" class="program-subjects-wrapper">
                                <p style="color: #666; font-style: italic;">Please select departments first to view available subjects</p>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons" style="margin-top: 20px;">
                        <button type="submit" style="background-color: var(--primary-color);">Add Faculty</button>
                        <button type="button" style="background-color: #6c757d;" onclick="resetForm(this.form)">Reset</button>
                    </div>

                    <div th:if="${successMessage}" class="message success" th:text="${successMessage}"></div>
                    <div th:if="${errorMessage}" class="message error" th:text="${errorMessage}"></div>
                </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Records Section -->
        <div class="records-section">
            <div class="tabs">
                <button class="tab active" onclick="switchRecordTab(event, 'student-records')">Student Records</button>
                <button class="tab" onclick="switchRecordTab(event, 'faculty-records')">Faculty Records</button>
                <button class="tab" onclick="switchRecordTab(event, 'pending-approvals')">Pending Approvals</button>
            </div>

            <div class="tab-contents">
            <!-- Student Records -->
            <div id="student-records" class="tab-content active">
                <h2>Student List</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1; max-width: 300px;">
                        <label for="programFilter">Filter by Program:</label>
                        <select id="programFilter" class="form-control">
                            <option value="all">All Programs</option>
                            <option th:each="program : ${programs}" th:value="${program.id}" th:text="${program.name}"></option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; max-width: 300px;">
                        <label for="yearFilter">Filter by Enrollment Year:</label>
                        <select id="yearFilter" class="form-control">
                            <option value="all">All Years</option>
                            <option th:each="year : ${enrollmentYears}" th:value="${year}" th:text="${year}"></option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; max-width: 300px;">
                        <label for="levelFilter">Filter by Year Level:</label>
                        <select id="levelFilter" class="form-control">
                            <option value="all">All Levels</option>
                            <option value="1">1st Year - Freshmen</option>
                            <option value="2">2nd Year - Sophomore</option>
                            <option value="3">3rd Year - Junior</option>
                            <option value="4">4th Year - Senior</option>
                        </select>
                    </div>
                </div>
                
                <div id="studentTable" th:if="${students != null and !students.empty}">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Student Number</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Year</th>
                                <th class="hidden-column">Semester</th>
                                <th class="hidden-column">Phone</th>
                                <th class="hidden-column">Address</th>
                                <th>Enrollment Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="student : ${students}" 
                                th:data-program="${student.program != null ? student.program.id : ''}"
                                th:data-year="${#temporals.format(student.enrollmentDate, 'yyyy')}"
                                th:data-level="${student.enrollmentYear}">
                                <td th:text="${student.id}"></td>
                                <td th:text="${student.studentNumber}"></td>
                                <td th:text="${student.firstName}"></td>
                                <td th:text="${student.lastName}"></td>
                                <td th:text="${student.email}"></td>
                                <td th:text="${student.program != null ? student.program.name : 'Not Assigned'}"></td>
                                <td th:text="${student.enrollmentYear}"></td>
                                <td class="hidden-column">
                                    <select class="form-control semester-select" 
                                            th:data-student-id="${student.id}"
                                            th:value="${student.currentSemester}">
                                        <option value="1" th:selected="${student.currentSemester == 1}">1st Semester</option>
                                        <option value="2" th:selected="${student.currentSemester == 2}">2nd Semester</option>
                                    </select>
                                </td>
                                <td class="hidden-column" th:text="${student.phoneNumber != null ? student.phoneNumber : 'N/A'}"></td>
                                <td class="hidden-column" th:text="${student.address != null ? student.address : 'N/A'}"></td>
                                <td th:text="${#temporals.format(student.enrollmentDate, 'yyyy-MM-dd')}"></td>
                                <td>
                                    <div class="action-buttons">
                                        <a th:href="@{'/admin/students/edit/' + ${student.id}}" 
                                           class="edit-btn" 
                                           style="text-decoration: none; color: white; padding: 8px 12px; border-radius: 4px;">Edit</a>
                                        <a th:href="@{'/admin/students/' + ${student.id} + '/grades'}" 
                                           class="edit-btn" 
                                           style="text-decoration: none; color: white; padding: 8px 12px; border-radius: 4px; background-color: #17a2b8;">Grades</a>
                                        <form th:action="@{'/admin/students/delete/' + ${student.id}}" method="post" style="margin: 0;">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                            <button type="submit" style="background-color: var(--danger-color);">Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="noStudentsMessage" style="display: none;" class="message">
                    No students found for the selected filters.
                </div>
                <div th:if="${students == null or students.empty}" class="message">
                    No students found.
                </div>
            </div>

            <!-- Faculty Records -->
            <div id="faculty-records" class="tab-content">
                <h2>Faculty List</h2>
                <div th:if="${faculties != null and !faculties.empty}">
                    <table>
                        <thead>
                            <tr>
                                <th>Faculty ID</th>
                                <th>Name</th>
                                <th>Departments</th>
                                <th>Position</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="faculty : ${faculties}">
                                <td th:text="${faculty.facultyId}"></td>
                                <td th:text="${faculty.firstName + ' ' + faculty.lastName}"></td>
                                <td>
                                    <span th:if="${faculty.facultyPrograms == null or faculty.facultyPrograms.empty}">Not Assigned</span>
                                    <span th:unless="${faculty.facultyPrograms == null or faculty.facultyPrograms.empty}" 
                                          th:text="${#strings.listJoin(faculty.facultyPrograms.![program.name], ', ')}">
                                    </span>
                                </td>
                                <td th:text="${faculty.position}"></td>
                                <td th:text="${faculty.email}"></td>
                                <td th:text="${faculty.phoneNumber != null ? faculty.phoneNumber : 'N/A'}"></td>
                                <td>
                                    <div class="action-buttons">
                                            <button type="button" 
                                                    onclick="openEditModal(this)"
                                                    th:data-faculty-id="${faculty.id}" 
                                           class="edit-btn" 
                                                    style="text-decoration: none; color: white; padding: 8px 12px; border-radius: 4px;">Edit</button>
                                        <button type="button" 
                                                onclick="deleteFaculty(this)"
                                                th:data-faculty-id="${faculty.id}"
                                                style="background-color: var(--danger-color);">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${faculties == null or faculties.empty}" class="message">
                    No faculty members found.
                    </div>
                </div>
            </div>

            <!-- Pending Approvals -->
            <div id="pending-approvals" class="tab-content">
                <h2>Pending Semester Approval Requests</h2>
                <div th:if="${pendingApprovals != null and !pendingApprovals.empty}">
                    <table>
                        <thead>
                            <tr>
                                <th>Student Number</th>
                                <th>Name</th>
                                <th>Year Level</th>
                                <th>Semester</th>
                                <th>Academic Year</th>
                                <th>Request Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="approval : ${pendingApprovals}" th:id="'approval-row-' + ${approval.id}">
                                <td th:text="${approval.student.studentNumber}"></td>
                                <td th:text="${approval.student.firstName + ' ' + approval.student.lastName}"></td>
                                <td th:text="${approval.student.enrollmentYear}"></td>
                                <td th:text="${approval.semester == 1 ? '1st Semester' : (approval.semester == 2 ? '2nd Semester' : approval.semester)}"></td>
                                <td th:text="${approval.academicYear}"></td>
                                <td th:text="${#temporals.format(approval.requestDate, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                    <form class="approval-action-form" th:action="@{'/approvals/' + ${approval.id} + '/process'}" method="post" th:attr="data-approval-id=${approval.id}" style="display:inline;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <input type="hidden" name="approved" value="true"/>
                                        <button type="submit" class="btn-primary">Approve</button>
                                    </form>
                                    <form class="approval-action-form" th:action="@{'/approvals/' + ${approval.id} + '/process'}" method="post" th:attr="data-approval-id=${approval.id}" style="display:inline; margin-left: 8px;">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <input type="hidden" name="approved" value="false"/>
                                        <button type="submit" style="background-color: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 4px;">Deny</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:if="${pendingApprovals == null or pendingApprovals.empty}" class="message">
                    No pending approval requests.
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Faculty Modal -->
    <div id="editFacultyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Faculty Member</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editFacultyForm">
                    <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                    <input type="hidden" id="editFacultyId" name="id"/>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFacultyIdInput">Faculty ID:</label>
                            <input type="text" id="editFacultyIdInput" name="facultyId" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editEmail">Email:</label>
                            <input type="email" id="editEmail" name="email" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFirstName">First Name:</label>
                            <input type="text" id="editFirstName" name="firstName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="editLastName">Last Name:</label>
                            <input type="text" id="editLastName" name="lastName" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editPassword">New Password (leave blank to keep current):</label>
                            <input type="password" id="editPassword" name="password"
                                   placeholder="Enter only if changing password">
                        </div>
                        
                        <div class="form-group">
                            <label for="editPosition">Position:</label>
                            <input type="text" id="editPosition" name="position" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editPhoneNumber">Phone Number:</label>
                            <input type="tel" id="editPhoneNumber" name="phoneNumber">
                        </div>
                        
                        <div class="form-group">
                            <label for="editAddress">Address:</label>
                            <input type="text" id="editAddress" name="address">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Departments:</label>
                            <div class="multiselect-dropdown">
                                <button type="button" class="multiselect-dropdown-toggle">
                                    <span>Select Departments</span>
                                </button>
                                <div class="multiselect-dropdown-list">
                                    <div th:each="program : ${programs}" class="multiselect-dropdown-option">
                                        <label>
                                            <input type="checkbox" 
                                                   name="programIds"
                                                   th:value="${program.id}">
                                            <span th:text="${program.name}"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editYearLevel">Year Level:</label>
                            <select id="editYearLevel" name="yearLevel" required>
                                <option value="">-- Select Year Level --</option>
                                <option value="1">1st Year - Freshmen</option>
                                <option value="2">2nd Year - Sophomore</option>
                                <option value="3">3rd Year - Junior</option>
                                <option value="4">4th Year - Senior</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Subject Assignments:</label>
                            <div id="editSubjectAssignments" class="program-subjects-wrapper">
                                <p style="color: #666; font-style: italic;">Please select departments and year level to view available subjects</p>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn-primary">Save Changes</button>
                        <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="approval-toast" style="display:none; position: fixed; top: 40px; right: 40px; z-index: 9999; min-width: 250px; background: #323232; color: #fff; padding: 16px 28px; border-radius: 6px; font-size: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); opacity: 0.95; transition: opacity 0.3s;">
        <span id="approval-toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Initialize form event listeners
            initializeFormEventListeners();
            
            // Initialize all multiselect dropdowns
            document.querySelectorAll('.multiselect-dropdown').forEach(container => {
                initializeMultiselect(container);
            });

            // Add event listeners for year level and semester changes in add faculty form
            const yearLevelSelect = document.getElementById('facultyYearLevel');
            const semesterSelect = document.getElementById('facultySemester');
            const addFacultyForm = document.getElementById('facultyForm');

            if (yearLevelSelect) {
                yearLevelSelect.addEventListener('change', loadSubjects);
            }
            
            if (semesterSelect) {
                semesterSelect.addEventListener('change', loadSubjects);
            }

            // Initialize multiselect for departments in add faculty form
            const addFacultyDepartments = addFacultyForm?.querySelector('.multiselect-dropdown');
            if (addFacultyDepartments) {
                const dropdownToggle = addFacultyDepartments.querySelector('.multiselect-dropdown-toggle');
                const dropdownList = addFacultyDepartments.querySelector('.multiselect-dropdown-list');
                const checkboxes = addFacultyDepartments.querySelectorAll('input[type="checkbox"]');
                
                // Add initial placeholder class
                dropdownToggle.classList.add('placeholder');

                // Toggle dropdown
                dropdownToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropdownList.classList.toggle('show');
                    dropdownToggle.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!addFacultyDepartments.contains(e.target)) {
                        dropdownList.classList.remove('show');
                        dropdownToggle.classList.remove('show');
                    }
                });

                // Handle checkbox changes
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateSelectedDepartments(addFacultyDepartments);
                        loadSubjects();
                    });

                    // Add click handler to label to prevent dropdown from closing
                    checkbox.closest('label').addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                });

                // Initial update of selected departments
                updateSelectedDepartments(addFacultyDepartments);
            }
            
            // Check if we should open the edit modal from URL
            const urlParams = new URLSearchParams(window.location.search);
            const editFacultyId = urlParams.get('editFaculty');
            if (editFacultyId) {
                openEditModal(null, editFacultyId);
            }
        });

        function updateSelectedDepartments(container) {
            const toggle = container.querySelector('.multiselect-dropdown-toggle');
            const toggleSpan = toggle.querySelector('span');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            
            const selectedDepartments = Array.from(checkboxes).map(cb => 
                cb.parentElement.querySelector('span').textContent
            );

            if (selectedDepartments.length === 0) {
                toggleSpan.textContent = 'Select Departments';
                toggle.classList.add('placeholder');
                toggle.classList.remove('has-selections');
            } else {
                toggleSpan.textContent = selectedDepartments.join(', ');
                toggle.classList.remove('placeholder');
                toggle.classList.add('has-selections');
            }
        }

        function loadSubjects() {
            const form = document.getElementById('facultyForm');
            const subjectAssignments = document.getElementById('subjectAssignments');
            const yearLevel = document.getElementById('facultyYearLevel').value;
            const semester = document.getElementById('facultySemester').value;
            const selectedDepartments = Array.from(
                form.querySelectorAll('.multiselect-dropdown input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            if (!yearLevel || !semester || selectedDepartments.length === 0) {
                subjectAssignments.innerHTML = 
                    '<p style="color: #666; font-style: italic;">Please select departments, year level, and semester to view available subjects</p>';
                return;
            }

            // Show loading state
            subjectAssignments.innerHTML = '<div class="loading-subjects">Loading subjects</div>';

            // Build the URL with all parameters
            const params = new URLSearchParams({
                yearLevel: yearLevel,
                semester: semester,
                departments: selectedDepartments.join(',')
            });

            fetch(`/admin/subjects/available?${params.toString()}`, {
                headers: {
                    'Accept': 'application/json',
                    [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.subjects || data.subjects.length === 0) {
                    subjectAssignments.innerHTML = 
                        '<div class="no-subjects-message">No subjects available for the selected criteria</div>';
                    return;
                }

                // Group subjects by department
                const subjectsByDepartment = {};
                data.subjects.forEach(subject => {
                    if (!subjectsByDepartment[subject.programName]) {
                        subjectsByDepartment[subject.programName] = [];
                    }
                    subjectsByDepartment[subject.programName].push(subject);
                });

                // Generate HTML for subjects
                let html = '';
                Object.entries(subjectsByDepartment).forEach(([department, subjects]) => {
                    html += `
                        <div class="program-subjects-section">
                            <h4>${department}</h4>
                            <div class="subject-grid">
                                ${subjects.map(subject => `
                                    <div class="subject-item">
                                        <label>
                                            <input type="checkbox" 
                                                   name="subjectIds" 
                                                   value="${subject.id}">
                                            <span>${subject.code} - ${subject.name}</span>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                subjectAssignments.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading subjects:', error);
                subjectAssignments.innerHTML = 
                    '<div class="error-message">Error loading subjects. Please try again.</div>';
            });
        }

        function initializeFormEventListeners() {
            // Add event listeners for year level and semester changes in edit form
            const editYearLevel = document.getElementById('editYearLevel');
            if (editYearLevel) {
                editYearLevel.addEventListener('change', () => loadEditSubjects());
            }
            
            // Add event listeners for department changes in edit form
            const programCheckboxes = document.querySelectorAll('#editFacultyForm input[name="programIds"]');
            programCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => loadEditSubjects());
            });

            // Initialize edit form submission handler
            const editForm = document.getElementById('editFacultyForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Submitting edit form');
                    
                    const formData = new FormData(this);
                    const facultyId = document.getElementById('editFacultyId').value;
                    
                    // Add all selected subjects to the form data
                    const allSubjects = Array.from(window.selectedSubjects.values());
                    if (allSubjects.length > 0) {
                        formData.append('subjectAssignments', JSON.stringify(allSubjects));
                    }
                    
                    // Get all program IDs
                    const programIds = Array.from(document.querySelectorAll('#editFacultyForm input[name="programIds"]:checked'))
                        .map(cb => cb.value);
                    
                    // Remove existing programIds from FormData and add as array
                    formData.delete('programIds');
                    programIds.forEach(id => formData.append('programIds', id));
                    
                    // Add CSRF token
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    formData.append('_csrf', csrfToken);
                    
                    console.log('Submitting with faculty ID:', facultyId);
                    console.log('Selected programs:', programIds);
                    console.log('All selected subjects:', allSubjects);
                    
                    fetch(`/admin/faculty/update-admin/${facultyId}`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            [document.querySelector('meta[name="_csrf_header"]').content]: csrfToken
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                try {
                                    // Try to parse as JSON first
                                    const jsonError = JSON.parse(text);
                                    throw new Error(jsonError.error || 'Error updating faculty member');
                                } catch (e) {
                                    // If not JSON, it might be HTML error page
                                    if (text.includes('500')) {
                                        throw new Error('Server error occurred while updating faculty member');
                                    } else {
                                        throw new Error('Error updating faculty member');
                                    }
                                }
                            });
                        }
                        return response.json();
                    })
                    .then(result => {
                        console.log('Update result:', result);
                        if (result.success) {
                            // Show success message
                            const successMessage = document.createElement('div');
                            successMessage.className = 'message success';
                            successMessage.textContent = result.message || 'Faculty member updated successfully';
                            document.querySelector('.modal-body').insertBefore(successMessage, document.querySelector('.modal-body form'));
                            
                            // Close modal after a short delay
                            setTimeout(() => {
                                closeEditModal();
                                // Refresh the page to show updated data
                                window.location.reload();
                            }, 1500);
                        } else {
                            throw new Error(result.message || 'Error updating faculty member');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Show error message in modal
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'message error';
                        errorMessage.textContent = error.message || 'Error updating faculty member';
                        document.querySelector('.modal-body').insertBefore(errorMessage, document.querySelector('.modal-body form'));
                        
                        // Remove error message after 5 seconds
                        setTimeout(() => {
                            errorMessage.remove();
                        }, 5000);
                    });
                });
            }
        }

        function openEditModal(button, facultyId = null) {
            // Get faculty ID either from button or parameter
            const id = facultyId || button.getAttribute('data-faculty-id');
            console.log('Opening edit modal for faculty ID:', id);
            
            const modal = document.getElementById('editFacultyModal');
            if (!modal) {
                console.error('Modal element not found');
                return;
            }
            
            // Show modal first to ensure form is in the DOM
            modal.style.display = 'block';
            
            // Initialize selectedSubjects map if it doesn't exist
            if (!window.selectedSubjects) {
                window.selectedSubjects = new Map();
            } else {
                // Clear previous selections
                window.selectedSubjects.clear();
            }
            
            // Fetch faculty data
            fetch(`/admin/faculty/${id}`, {
                headers: {
                    'Accept': 'application/json',
                    [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(faculty => {
                console.log('Loaded faculty data:', faculty);
                
                // Reset the form
                document.getElementById('editFacultyForm').reset();
                
                // Populate form fields
                document.getElementById('editFacultyId').value = faculty.id;
                document.getElementById('editFacultyIdInput').value = faculty.facultyId;
                document.getElementById('editEmail').value = faculty.email;
                document.getElementById('editFirstName').value = faculty.firstName;
                document.getElementById('editLastName').value = faculty.lastName;
                document.getElementById('editPosition').value = faculty.position;
                document.getElementById('editPhoneNumber').value = faculty.phoneNumber || '';
                document.getElementById('editAddress').value = faculty.address || '';
                document.getElementById('editYearLevel').value = faculty.yearLevel || '';
                
                // Set departments
                const departmentCheckboxes = document.querySelectorAll('#editFacultyForm input[name="programIds"]');
                departmentCheckboxes.forEach(checkbox => {
                    checkbox.checked = faculty.programIds.includes(parseInt(checkbox.value));
                });
                
                // Store all subject assignments in the window.selectedSubjects map
                if (faculty.subjects && Array.isArray(faculty.subjects)) {
                    faculty.subjects.forEach(subject => {
                        const key = `${subject.yearLevel}-${subject.semester}-${subject.id}`;
                        window.selectedSubjects.set(key, {
                            id: subject.id,
                            yearLevel: subject.yearLevel,
                            semester: subject.semester
                        });
                    });
                }
                
                // Update the departments dropdown display
                const dropdownContainer = document.querySelector('#editFacultyForm .multiselect-dropdown');
                updateSelectedDepartments(dropdownContainer);
                
                // Load subjects for the current year level
                if (faculty.yearLevel) {
                    loadEditSubjects();
                }
            })
            .catch(error => {
                console.error('Error loading faculty data:', error);
                modal.querySelector('.modal-body').innerHTML = `
                    <div class="error-message">
                        Error loading faculty data: ${error.message}<br>
                        Please try again or contact support if the problem persists.
                    </div>`;
            });
        }

        function closeEditModal() {
            const modal = document.getElementById('editFacultyModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editFacultyModal');
            if (event.target == modal) {
                closeEditModal();
            }
        }

        function switchTab(event, tabId) {
            console.log('switchTab called with:', { event, tabId });
            
            // Get the container for form tabs
            const container = document.querySelector('.form-tabs-content');
            console.log('Form tabs container:', container);
            
            // Hide all form tab contents
            const tabContents = container.querySelectorAll('.tab-contents > .tab-content');
            console.log('Found tab contents:', tabContents.length);
            tabContents.forEach(content => {
                content.classList.remove('active');
                console.log('Removed active from:', content.id);
            });
            
            // Deactivate all form tabs
            const tabs = container.querySelectorAll('.tabs > .tab');
            console.log('Found tabs:', tabs.length);
            tabs.forEach(tab => {
                tab.classList.remove('active');
                console.log('Removed active from tab:', tab.textContent);
            });
            
            // Activate selected tab and content
            const selectedContent = document.getElementById(tabId);
            const selectedTab = event.target;
            console.log('Activating:', { content: selectedContent, tab: selectedTab });
            
            if (selectedContent) {
                selectedContent.classList.add('active');
            } else {
                console.error('Could not find tab content:', tabId);
            }
            
            if (selectedTab) {
                selectedTab.classList.add('active');
            } else {
                console.error('Could not find tab element');
            }
        }

        function switchRecordTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.querySelectorAll('.records-section .tab-content');
            tablinks = document.querySelectorAll('.records-section .tab');
            tabcontent.forEach(function(tc) { tc.classList.remove('active'); });
            tablinks.forEach(function(tl) { tl.classList.remove('active'); });
            document.getElementById(tabName).classList.add('tab-content', 'active');
            evt.currentTarget.classList.add('active');
        }

        function resetForm(form) {
            form.reset();
            // Clear any validation messages
            const errorSpans = form.getElementsByClassName('error-message');
            for (let span of errorSpans) {
                span.style.display = 'none';
            }
            // Clear any custom validity
            const inputs = form.getElementsByTagName('input');
            for (let input of inputs) {
                input.setCustomValidity('');
            }
        }

        function editStudent(button) {
            const row = button.closest('tr');
            const studentId = row.cells[0].textContent;
            window.location.href = `/admin/students/edit/${studentId}`;
        }

        function deleteStudent(button) {
            if (confirm('Are you sure you want to delete this student?')) {
                const row = button.closest('tr');
                const studentId = row.cells[0].textContent;
                // Send delete request
                fetch(`/admin/students/delete/${studentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        row.remove();
                    } else {
                        alert('Failed to delete student');
                    }
                });
            }
        }

        function deleteFaculty(button) {
            if (confirm('Are you sure you want to delete this faculty member?')) {
                const facultyId = button.getAttribute('data-faculty-id');
                fetch(`/admin/faculty/delete/${facultyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        button.closest('tr').remove();
                    } else {
                        alert('Error deleting faculty member: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting faculty member');
                });
            }
        }

        // Client-side form validation
        document.getElementById('studentForm').addEventListener('submit', function(e) {
            // Validation for other fields
            const password = document.getElementById('password').value;
            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                e.preventDefault();
                return false;
            }
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            if (phoneNumber && !phoneNumber.match(/^[0-9\-\+\(\) ]+$/)) {
                alert('Please enter a valid phone number');
                e.preventDefault();
                return false;
            }
            
            const enrollmentYear = document.getElementById('enrollmentYear').value;
            if (!enrollmentYear) {
                alert('Please select a year level');
                e.preventDefault();
                return false;
            }
            
            return true;
        });
        
        // Program and Enrollment Date filter functionality
        document.addEventListener('DOMContentLoaded', function() {
            const programFilter = document.getElementById('programFilter');
            const yearFilter = document.getElementById('yearFilter');
            const levelFilter = document.getElementById('levelFilter');
            const studentTable = document.getElementById('studentTable');
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            
            // Function to apply filters
            function applyFilters() {
                const selectedProgramId = programFilter.value;
                const selectedYear = yearFilter.value;
                const selectedLevel = levelFilter.value;
                let visibleStudents = 0;
                
                // Get all student rows
                const studentRows = document.querySelectorAll('tbody tr');
                
                studentRows.forEach(function(row) {
                    const programId = row.getAttribute('data-program');
                    const enrollmentYear = row.getAttribute('data-year');
                    const yearLevel = row.getAttribute('data-level');
                    
                    // Check if matches all filters
                    const matchesProgram = selectedProgramId === 'all' || programId === selectedProgramId;
                    const matchesYear = selectedYear === 'all' || enrollmentYear === selectedYear;
                    const matchesLevel = selectedLevel === 'all' || yearLevel === selectedLevel;
                    
                    // Show if matches all filters
                    if (matchesProgram && matchesYear && matchesLevel) {
                        row.style.display = '';
                        visibleStudents++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show/hide "no students" message based on filter results
                if (visibleStudents === 0 && studentRows.length > 0) {
                    studentTable.style.display = 'none';
                    noStudentsMessage.style.display = 'block';
                } else {
                    studentTable.style.display = 'block';
                    noStudentsMessage.style.display = 'none';
                }
            }
            
            // Add event listeners to all dropdowns
            if (programFilter) {
                programFilter.addEventListener('change', applyFilters);
            }
            
            if (yearFilter) {
                yearFilter.addEventListener('change', applyFilters);
            }
            
            if (levelFilter) {
                levelFilter.addEventListener('change', applyFilters);
            }
        });

        // Add this JavaScript for faculty ID validation
        document.getElementById('facultyForm').addEventListener('submit', function(e) {
            console.log('Form submission started');
            
            // Log all form values
            const formData = new FormData(this);
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            const phoneNumber = document.getElementById('phoneNumber').value;
            if (phoneNumber && !phoneNumber.match(/^[0-9\-\+\(\) ]+$/)) {
                console.log('Phone number validation failed');
                alert('Please enter a valid phone number');
                e.preventDefault();
                return false;
            }

            console.log('Form validation passed');
            return true;
        });

        function checkFacultyIdUnique(facultyId) {
            if (!facultyId) return;
            
            console.log('Checking faculty ID:', facultyId);
            fetch(`/admin/faculty/check-id/${facultyId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Faculty ID check response:', data);
                    const errorSpan = document.getElementById('facultyIdError');
                    if (data.exists) {
                        errorSpan.textContent = 'This Faculty ID is already taken';
                        errorSpan.style.display = 'block';
                        document.getElementById('facultyId').setCustomValidity('Faculty ID already exists');
                    } else {
                        errorSpan.style.display = 'none';
                        document.getElementById('facultyId').setCustomValidity('');
                    }
                })
                .catch(error => {
                    console.error('Error checking faculty ID:', error);
                });
        }

        function initializeMultiselect(container) {
            const dropdownToggle = container.querySelector('.multiselect-dropdown-toggle');
            const dropdownList = container.querySelector('.multiselect-dropdown-list');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            
            // Add initial placeholder class
            dropdownToggle.classList.add('placeholder');

            // Toggle dropdown
            dropdownToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropdownList.classList.toggle('show');
                dropdownToggle.classList.toggle('show');
                
                if (dropdownList.classList.contains('show')) {
                    // Ensure the dropdown is visible within the viewport
                    const rect = dropdownList.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    
                    if (rect.bottom > viewportHeight) {
                        dropdownList.style.maxHeight = `${viewportHeight - rect.top - 20}px`;
                    }
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    dropdownList.classList.remove('show');
                    dropdownToggle.classList.remove('show');
                }
            });

            // Handle checkbox changes
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectedDepartments(container);
                    if (container.closest('#editFacultyForm')) {
                        loadEditSubjects();
                    } else {
                        loadSubjects();
                    }
                });

                // Add click handler to label to prevent dropdown from closing
                checkbox.closest('label').addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });

            // Initial update of selected departments
            updateSelectedDepartments(container);
        }

        function loadEditSubjects() {
            const yearLevel = document.getElementById('editYearLevel').value;
            const selectedDepartments = Array.from(
                document.querySelectorAll('#editFacultyForm input[name="programIds"]:checked')
            ).map(cb => cb.value);
            
            if (!yearLevel || selectedDepartments.length === 0) {
                document.getElementById('editSubjectAssignments').innerHTML = 
                    '<p style="color: #666; font-style: italic;">Please select departments and year level to view available subjects</p>';
                return;
            }
            
            // Store current selections before loading new subjects
            const currentSelections = new Map();
            document.querySelectorAll('#editSubjectAssignments input[type="checkbox"]:checked').forEach(checkbox => {
                const key = `${checkbox.getAttribute('data-year')}-${checkbox.getAttribute('data-semester')}-${checkbox.value}`;
                currentSelections.set(key, {
                    id: parseInt(checkbox.value),
                    yearLevel: parseInt(checkbox.getAttribute('data-year')),
                    semester: parseInt(checkbox.getAttribute('data-semester'))
                });
            });
            
            // Show loading state
            document.getElementById('editSubjectAssignments').innerHTML = 
                '<div class="loading-subjects">Loading available subjects</div>';
            
            // We'll fetch subjects for both semesters
            Promise.all([1, 2].map(semester => {
                const params = new URLSearchParams({
                    yearLevel: yearLevel,
                    semester: semester,
                    departments: selectedDepartments.join(',')
                });
                
                return fetch(`/admin/subjects/available?${params.toString()}`, {
                    headers: {
                        'Accept': 'application/json',
                        [document.querySelector('meta[name="_csrf_header"]').content]: document.querySelector('meta[name="_csrf"]').content
                    }
                }).then(response => response.json());
            }))
            .then(([firstSemesterData, secondSemesterData]) => {
                let html = '';
                
                // Process both semesters
                [
                    { data: firstSemesterData, title: '1st Semester', semesterNum: 1 },
                    { data: secondSemesterData, title: '2nd Semester', semesterNum: 2 }
                ].forEach(({ data, title, semesterNum }) => {
                    if (!data.subjects || data.subjects.length === 0) {
                        return;
                    }
                    
                    html += `
                        <div class="semester-container">
                            <div class="semester-header">${title}</div>
                            <div class="semester-content">
                    `;
                    
                    // Group subjects by department for this semester
                    const subjectsByDepartment = {};
                    data.subjects.forEach(subject => {
                        if (!subjectsByDepartment[subject.programName]) {
                            subjectsByDepartment[subject.programName] = [];
                        }
                        subjectsByDepartment[subject.programName].push(subject);
                    });
                    
                    Object.entries(subjectsByDepartment).forEach(([department, subjects]) => {
                        html += `
                            <div class="program-subjects-section">
                                <h4>${department}</h4>
                                <div class="subject-grid">
                                    ${subjects.map(subject => {
                                        const key = `${yearLevel}-${semesterNum}-${subject.id}`;
                                        // Check both current selections and window.selectedSubjects
                                        const isAssigned = currentSelections.has(key) || window.selectedSubjects.has(key);
                                        return `
                                            <div class="subject-item">
                                                <label>
                                                    <input type="checkbox" 
                                                           name="subjectIds" 
                                                           value="${subject.id}"
                                                           data-year="${yearLevel}"
                                                           data-semester="${semesterNum}"
                                                           onchange="handleSubjectSelection(this)"
                                                           ${isAssigned ? 'checked' : ''}>
                                                    <span>${subject.code} - ${subject.name}</span>
                                                </label>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="no-subjects-message">No subjects available for the selected criteria</div>';
                }
                
                document.getElementById('editSubjectAssignments').innerHTML = html;

                // Restore all previous selections that weren't in the current view
                currentSelections.forEach((subject, key) => {
                    if (!document.querySelector(`input[type="checkbox"][data-year="${subject.yearLevel}"][data-semester="${subject.semester}"][value="${subject.id}"]`)) {
                        window.selectedSubjects.set(key, subject);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading subjects:', error);
                document.getElementById('editSubjectAssignments').innerHTML = 
                    '<div class="error-message">Error loading subjects. Please try again.</div>';
            });
        }

        function handleSubjectSelection(checkbox) {
            const yearLevel = parseInt(checkbox.getAttribute('data-year'));
            const semester = parseInt(checkbox.getAttribute('data-semester'));
            const subjectId = parseInt(checkbox.value);
            const key = `${yearLevel}-${semester}-${subjectId}`;
            
            if (checkbox.checked) {
                window.selectedSubjects.set(key, {
                    id: subjectId,
                    yearLevel: yearLevel,
                    semester: semester
                });
            } else {
                window.selectedSubjects.delete(key);
            }

            // Log current selections for debugging
            console.log('Current selections:', {
                totalSelected: window.selectedSubjects.size,
                selections: Array.from(window.selectedSubjects.entries())
            });
        }

        function showApprovalToast(message) {
            const toast = document.getElementById('approval-toast');
            const toastMsg = document.getElementById('approval-toast-message');
            toastMsg.textContent = message;
            toast.style.display = 'block';
            toast.style.opacity = '0.95';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { toast.style.display = 'none'; }, 400);
            }, 2200);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.approval-action-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const action = form.getAttribute('action');
                    const approvalId = form.getAttribute('data-approval-id');
                    fetch(action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams([...formData])
                    })
                    .then(response => {
                        if (response.ok) {
                            // Remove the row from the table
                            const row = document.getElementById('approval-row-' + approvalId);
                            if (row) row.remove();
                            // Show toast
                            const isApprove = form.querySelector('input[name="approved"]').value === 'true';
                            showApprovalToast(isApprove ? 'Request approved successfully' : 'Request denied successfully');
                        } else {
                            alert('Failed to process request.');
                        }
                    })
                    .catch(() => alert('Error processing request.'));
                });
            });
        });
    </script>
    
    <!-- Add the faculty-form.js script -->
    <script src="/js/faculty-form.js"></script>
</body>
</html>